{% extends "base.html" %}

{% block title %}Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ - ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« | {{ settings.app_name }}{% endblock %}

{% block og_title %}Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ - {{ settings.app_name }}{% endblock %}
{% block og_description %}ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ÙˆØ­ÙØ¸ Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ† Ø§Ù„Ù†ÙˆÙˆÙŠØ© ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©.{% endblock %}
{% block og_url %}{{ settings.site_url }}/profile{% endblock %}
{% block tw_title %}Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ - {{ settings.app_name }}{% endblock %}
{% block tw_description %}ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ÙˆØ­ÙØ¸ Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ† Ø§Ù„Ù†ÙˆÙˆÙŠØ©.{% endblock %}
{% block canonical %}{{ settings.site_url }}/profile{% endblock %}

{% block meta %}
{{ super() }}
<meta name="description" content="ØµÙØ­Ø© Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ ÙÙŠ Ù†Ø¨Ø±Ø§Ø³ - ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ÙˆØ­ÙØ¸ Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ† Ø§Ù„Ù†ÙˆÙˆÙŠØ© ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ.">
<meta name="keywords" content="Ù…Ù„Ù Ø´Ø®ØµÙŠØŒ ØªÙ‚Ø¯Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŒ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«ØŒ Ù†Ø¨Ø±Ø§Ø³">
<meta name="robots" content="noindex, follow">
{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 900px;
        margin: 0 auto;
        padding: clamp(24px, 6vw, 48px) clamp(16px, 4vw, 24px);
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .profile-header {
        background: linear-gradient(135deg, var(--color-primary-soft) 0%, transparent 100%);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: clamp(24px, 6vw, 40px);
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 24px;
        flex-wrap: wrap;
        animation: fadeIn 0.5s ease-out;
    }

    .avatar-wrap {
        position: relative;
        flex-shrink: 0;
    }

    .avatar {
        width: clamp(72px, 15vw, 96px);
        height: clamp(72px, 15vw, 96px);
        border-radius: 50%;
        background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(28px, 7vw, 40px);
        color: white;
        font-weight: 700;
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .avatar:hover { transform: scale(1.05); }

    .avatar-edit {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 26px;
        height: 26px;
        background: var(--color-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .avatar-edit .material-icons-outlined { font-size: 14px; color: white; }

    .profile-info { flex: 1; min-width: 200px; }

    .profile-name {
        font-size: clamp(20px, 5vw, 28px);
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .profile-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: var(--color-primary-soft);
        color: var(--color-primary);
        font-size: 11px;
        font-weight: 600;
        padding: 2px 10px;
        border-radius: var(--radius-full);
        border: 1px solid rgba(16,185,129,0.3);
    }

    .profile-joined {
        font-size: 13px;
        color: var(--color-text-secondary);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .profile-stats {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .stat-item {
        text-align: center;
        min-width: 60px;
    }

    .stat-number {
        font-size: clamp(20px, 5vw, 26px);
        font-weight: 700;
        color: var(--color-primary);
        line-height: 1;
    }

    .stat-label {
        font-size: 11px;
        color: var(--color-text-secondary);
        margin-top: 3px;
    }

    /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tabs {
        display: flex;
        gap: 4px;
        background: var(--color-bg-hover);
        border-radius: var(--radius-md);
        padding: 4px;
        margin-bottom: 24px;
        overflow-x: auto;
    }

    .tab-btn {
        flex: 1;
        min-width: 100px;
        padding: 10px 16px;
        background: transparent;
        border: none;
        border-radius: calc(var(--radius-md) - 4px);
        color: var(--color-text-secondary);
        font-family: var(--font-family);
        font-size: clamp(12px, 2.5vw, 14px);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        white-space: nowrap;
    }

    .tab-btn.active {
        background: var(--color-bg-card);
        color: var(--color-primary);
        box-shadow: 0 2px 8px var(--color-shadow);
    }

    .tab-btn .material-icons-outlined { font-size: 18px; }

    /* â”€â”€ Tab Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-panel { display: none; animation: fadeIn 0.3s ease-out; }
    .tab-panel.active { display: block; }

    /* â”€â”€ Saved Hadiths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .saved-grid {
        display: grid;
        gap: 14px;
    }

    .saved-card {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: clamp(16px, 4vw, 20px);
        display: flex;
        align-items: flex-start;
        gap: 16px;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s;
        position: relative;
    }

    .saved-card:hover {
        border-color: var(--color-primary);
        background: var(--color-bg-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px var(--color-shadow);
    }

    .saved-card-num {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--color-primary-soft);
        color: var(--color-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        flex-shrink: 0;
    }

    .saved-card-body { flex: 1; min-width: 0; }

    .saved-card-title {
        font-size: clamp(14px, 3vw, 16px);
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .saved-card-meta {
        font-size: 12px;
        color: var(--color-text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .unsave-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--color-text-secondary);
        padding: 4px;
        border-radius: 6px;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .unsave-btn:hover { color: #ef4444; background: rgba(239,68,68,0.1); }
    .unsave-btn .material-icons-outlined { font-size: 18px; }

    .empty-state {
        text-align: center;
        padding: clamp(40px, 10vw, 64px) 24px;
        background: var(--color-bg-card);
        border: 1px dashed var(--color-border);
        border-radius: var(--radius-lg);
    }

    .empty-state .material-icons-outlined {
        font-size: 48px;
        color: var(--color-text-secondary);
        opacity: 0.4;
        margin-bottom: 12px;
        display: block;
    }

    .empty-state p {
        color: var(--color-text-secondary);
        margin-bottom: 16px;
        font-size: 15px;
    }

    .empty-state a {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 20px;
        background: var(--color-primary);
        color: white;
        border-radius: var(--radius-md);
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: background 0.2s;
    }

    .empty-state a:hover { background: var(--color-primary-dark); }

    /* â”€â”€ Activity / Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .progress-section {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: clamp(20px, 5vw, 32px);
        margin-bottom: 16px;
    }

    .progress-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .progress-title .material-icons-outlined { color: var(--color-primary); font-size: 20px; }

    .progress-list { display: grid; gap: 14px; }

    .progress-item { display: flex; align-items: center; gap: 12px; }

    .progress-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--color-text-primary);
        min-width: 110px;
        flex-shrink: 0;
    }

    .progress-bar-wrap {
        flex: 1;
        height: 8px;
        background: var(--color-bg-hover);
        border-radius: var(--radius-full);
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light));
        border-radius: var(--radius-full);
        transition: width 1s ease-out;
    }

    .progress-pct {
        font-size: 12px;
        font-weight: 700;
        color: var(--color-primary);
        min-width: 36px;
        text-align: left;
    }

    /* â”€â”€ Achievements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
    }

    .achievement {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: 16px 12px;
        text-align: center;
        transition: all 0.2s;
    }

    .achievement.earned {
        border-color: rgba(16,185,129,0.3);
        background: var(--color-primary-soft);
    }

    .achievement:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--color-shadow); }

    .achievement-icon {
        font-size: 32px;
        margin-bottom: 8px;
        filter: grayscale(1);
        opacity: 0.4;
    }

    .achievement.earned .achievement-icon { filter: none; opacity: 1; }

    .achievement-name {
        font-size: 12px;
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 4px;
    }

    .achievement-desc {
        font-size: 11px;
        color: var(--color-text-secondary);
    }

    /* â”€â”€ Settings Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .settings-card {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        margin-bottom: 16px;
    }

    .settings-row {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        gap: 14px;
        border-bottom: 1px solid var(--color-border);
        transition: background 0.15s;
    }

    .settings-row:last-child { border-bottom: none; }
    .settings-row:hover { background: var(--color-bg-hover); }

    .settings-icon {
        width: 38px;
        height: 38px;
        border-radius: var(--radius-md);
        background: var(--color-primary-soft);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .settings-icon .material-icons-outlined { font-size: 18px; color: var(--color-primary); }

    .settings-text { flex: 1; }

    .settings-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-text-primary);
    }

    .settings-sub {
        font-size: 12px;
        color: var(--color-text-secondary);
        margin-top: 2px;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .danger-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: var(--radius-md);
        font-family: var(--font-family);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .danger-btn:hover { background: rgba(239, 68, 68, 0.2); }

    /* â”€â”€ Login Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .login-banner {
        background: linear-gradient(135deg, var(--color-primary-soft), transparent);
        border: 1px solid rgba(16,185,129,0.2);
        border-radius: var(--radius-lg);
        padding: clamp(20px, 5vw, 32px);
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
        animation: fadeIn 0.4s ease-out;
    }

    .login-banner .material-icons-outlined { font-size: 36px; color: var(--color-primary); flex-shrink: 0; }

    .login-banner-text { flex: 1; min-width: 200px; }
    .login-banner-text h3 { font-size: 16px; font-weight: 700; color: var(--color-text-primary); margin-bottom: 4px; }
    .login-banner-text p { font-size: 13px; color: var(--color-text-secondary); }

    .login-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-family: var(--font-family);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        text-decoration: none;
        white-space: nowrap;
    }

    .login-btn:hover { background: var(--color-primary-dark); }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(16px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">

    <!-- Login Banner (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø²ÙˆØ§Ø± ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†) -->
    <div class="login-banner" id="login-banner" style="display:none;">
        <span class="material-icons-outlined">lock_open</span>
        <div class="login-banner-text">
            <h3>Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ</h3>
            <p>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø£Ø¬Ù‡Ø²ØªÙƒ</p>
        </div>
        <a href="#" class="login-btn">
            <span class="material-icons-outlined">login</span>
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </a>
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
        <div class="avatar-wrap">
            <div class="avatar" id="profile-avatar">Ø£</div>
            <div class="avatar-edit" title="ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©">
                <span class="material-icons-outlined">edit</span>
            </div>
        </div>

        <div class="profile-info">
            <div class="profile-name">
                <span id="profile-name-text">Ø²Ø§Ø¦Ø±</span>
                <span class="profile-badge">
                    <span class="material-icons-outlined" style="font-size:12px">verified</span>
                    Ù‚Ø§Ø±Ø¦
                </span>
            </div>
            <div class="profile-joined">
                <span class="material-icons-outlined" style="font-size:15px">calendar_today</span>
                <span id="profile-joined">Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯</span>
            </div>
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-number" id="stat-saved">0</div>
                    <div class="stat-label">Ù…Ø­ÙÙˆØ¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="stat-read">0</div>
                    <div class="stat-label">Ù…Ù‚Ø±ÙˆØ¡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="stat-quiz">0</div>
                    <div class="stat-label">Ø§Ø®ØªØ¨Ø§Ø±</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="stat-streak">0</div>
                    <div class="stat-label">ÙŠÙˆÙ… Ù…ØªØªØ§Ù„ÙŠ ğŸ”¥</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist">
        <button class="tab-btn active" onclick="switchTab('saved', this)" role="tab">
            <span class="material-icons-outlined">bookmark</span>
            Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª
        </button>
        <button class="tab-btn" onclick="switchTab('progress', this)" role="tab">
            <span class="material-icons-outlined">trending_up</span>
            Ø§Ù„ØªÙ‚Ø¯Ù…
        </button>
        <button class="tab-btn" onclick="switchTab('achievements', this)" role="tab">
            <span class="material-icons-outlined">emoji_events</span>
            Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª
        </button>
        <button class="tab-btn" onclick="switchTab('settings', this)" role="tab">
            <span class="material-icons-outlined">settings</span>
            Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </button>
    </div>

    <!-- Panel: Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª -->
    <div class="tab-panel active" id="panel-saved">
        <div class="saved-grid" id="saved-list"></div>
    </div>

    <!-- Panel: Ø§Ù„ØªÙ‚Ø¯Ù… -->
    <div class="tab-panel" id="panel-progress">
        <div class="progress-section">
            <div class="progress-title">
                <span class="material-icons-outlined">auto_graph</span>
                ØªÙ‚Ø¯Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
            </div>
            <div class="progress-list" id="progress-list">
                <div class="progress-item">
                    <span class="progress-label">Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</span>
                    <div class="progress-bar-wrap">
                        <div class="progress-bar" id="bar-read" style="width:0%"></div>
                    </div>
                    <span class="progress-pct" id="pct-read">0%</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</span>
                    <div class="progress-bar-wrap">
                        <div class="progress-bar" id="bar-saved" style="width:0%"></div>
                    </div>
                    <span class="progress-pct" id="pct-saved">0%</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span>
                    <div class="progress-bar-wrap">
                        <div class="progress-bar" id="bar-quiz" style="width:0%;background:linear-gradient(90deg,#f59e0b,#fcd34d)"></div>
                    </div>
                    <span class="progress-pct" id="pct-quiz">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel: Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª -->
    <div class="tab-panel" id="panel-achievements">
        <div class="achievements-grid" id="achievements-grid"></div>
    </div>

    <!-- Panel: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div class="tab-panel" id="panel-settings">
        <!-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… -->
        <div class="settings-card">
            <div class="settings-row">
                <div class="settings-icon"><span class="material-icons-outlined">person</span></div>
                <div class="settings-text">
                    <div class="settings-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</div>
                    <input type="text" id="name-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ"
                        style="background:var(--color-bg-hover);border:1px solid var(--color-border);border-radius:8px;padding:6px 10px;font-family:var(--font-family);font-size:13px;color:var(--color-text-primary);width:100%;margin-top:6px;"
                        onchange="saveName(this.value)">
                </div>
            </div>
        </div>

        <!-- ØªØµØ¯ÙŠØ± / Ø§Ø³ØªÙŠØ±Ø§Ø¯ / Ù…Ø³Ø­ -->
        <div class="settings-card">
            <!-- ØªØµØ¯ÙŠØ± -->
            <div class="settings-row">
                <div class="settings-icon"><span class="material-icons-outlined">download</span></div>
                <div class="settings-text">
                    <div class="settings-label">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                    <div class="settings-sub" id="export-sub">Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
                </div>
                <button class="login-btn" onclick="showExportPreview()" style="font-size:12px;padding:7px 14px;">
                    <span class="material-icons-outlined" style="font-size:15px">download</span>
                    ØªØµØ¯ÙŠØ±
                </button>
            </div>
            <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
            <div class="settings-row">
                <div class="settings-icon"><span class="material-icons-outlined">upload</span></div>
                <div class="settings-text">
                    <div class="settings-label">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                    <div class="settings-sub">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ù…Ù„Ù Ù†Ø¨Ø±Ø§Ø³ (.json)</div>
                </div>
                <button class="login-btn" onclick="document.getElementById('import-file').click()" style="font-size:12px;padding:7px 14px;">
                    <span class="material-icons-outlined" style="font-size:15px">upload</span>
                    Ø§Ø³ØªÙŠØ±Ø§Ø¯
                </button>
                <input type="file" id="import-file" accept=".json" style="display:none" onchange="handleImportFile(event)">
            </div>
            <!-- Ù…Ø³Ø­ -->
            <div class="settings-row">
                <div class="settings-icon" style="background:rgba(239,68,68,0.1)">
                    <span class="material-icons-outlined" style="color:#ef4444">delete_forever</span>
                </div>
                <div class="settings-text">
                    <div class="settings-label" style="color:#ef4444">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                    <div class="settings-sub">Ø­Ø°Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
                </div>
                <button class="danger-btn" onclick="showClearConfirm()">
                    <span class="material-icons-outlined" style="font-size:15px">warning</span>
                    Ù…Ø³Ø­
                </button>
            </div>
        </div>
    </div>

    <!-- â”€â”€ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="modal-export" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:16px;">
        <div style="background:var(--color-bg-card);border:1px solid var(--color-border);border-radius:var(--radius-lg);max-width:460px;width:100%;max-height:90vh;overflow-y:auto;animation:slideDown 0.25s ease-out;">
            <div style="padding:24px 24px 0;display:flex;align-items:center;justify-content:space-between;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <span style="font-size:26px;">ğŸ“¦</span>
                    <div>
                        <div style="font-size:16px;font-weight:700;color:var(--color-text-primary);">ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</div>
                        <div style="font-size:12px;color:var(--color-text-secondary);">Ù…Ù„Ø®Øµ Ù…Ø§ Ø³ÙŠØªÙ… ØªØµØ¯ÙŠØ±Ù‡</div>
                    </div>
                </div>
                <button onclick="closeModal('modal-export')" style="background:none;border:none;cursor:pointer;color:var(--color-text-secondary);padding:4px;border-radius:6px;">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div id="export-summary" style="padding:20px 24px;"></div>
            <div style="padding:0 24px 24px;display:flex;gap:10px;">
                <button class="login-btn" onclick="doExport()" style="flex:1;justify-content:center;">
                    <span class="material-icons-outlined" style="font-size:16px;">download</span>
                    ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                </button>
                <button onclick="closeModal('modal-export')" style="flex:1;padding:10px;background:var(--color-bg-hover);border:1px solid var(--color-border);border-radius:var(--radius-md);cursor:pointer;font-family:var(--font-family);font-size:14px;color:var(--color-text-secondary);">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>

    <!-- â”€â”€ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="modal-import" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:16px;">
        <div style="background:var(--color-bg-card);border:1px solid var(--color-border);border-radius:var(--radius-lg);max-width:460px;width:100%;max-height:90vh;overflow-y:auto;animation:slideDown 0.25s ease-out;">
            <div style="padding:24px 24px 0;display:flex;align-items:center;justify-content:space-between;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <span style="font-size:26px;">ğŸ“¥</span>
                    <div>
                        <div style="font-size:16px;font-weight:700;color:var(--color-text-primary);">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                        <div style="font-size:12px;color:var(--color-text-secondary);">Ø±Ø§Ø¬Ø¹ Ù…Ø§ Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡</div>
                    </div>
                </div>
                <button onclick="closeModal('modal-import')" style="background:none;border:none;cursor:pointer;color:var(--color-text-secondary);padding:4px;border-radius:6px;">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div id="import-summary" style="padding:20px 24px;"></div>
            <div id="import-conflict-box" style="display:none;margin:0 24px 16px;padding:12px 14px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:var(--radius-md);">
                <div style="font-size:12px;font-weight:700;color:#f59e0b;margin-bottom:4px;">âš ï¸ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                <div id="import-conflict-text" style="font-size:12px;color:var(--color-text-secondary);line-height:1.5;"></div>
            </div>
            <div style="padding:0 24px 12px;display:flex;gap:10px;">
                <button class="login-btn" onclick="doImport('merge')" style="flex:1;justify-content:center;background:#10b981;">
                    <span class="material-icons-outlined" style="font-size:15px;">merge</span>
                    Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                </button>
                <button class="login-btn" onclick="doImport('replace')" style="flex:1;justify-content:center;background:#f59e0b;">
                    <span class="material-icons-outlined" style="font-size:15px;">swap_horiz</span>
                    Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙ„
                </button>
            </div>
            <div style="padding:0 24px 20px;text-align:center;">
                <button onclick="closeModal('modal-import')" style="background:none;border:none;cursor:pointer;font-family:var(--font-family);font-size:13px;color:var(--color-text-secondary);">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- â”€â”€ Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³Ø­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="modal-clear" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:16px;">
        <div style="background:var(--color-bg-card);border:1px solid var(--color-border);border-radius:var(--radius-lg);max-width:380px;width:100%;animation:slideDown 0.25s ease-out;">
            <div style="padding:32px 24px;text-align:center;">
                <div style="font-size:48px;margin-bottom:16px;">âš ï¸</div>
                <div style="font-size:17px;font-weight:700;color:var(--color-text-primary);margin-bottom:8px;">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ</div>
                <div style="font-size:13px;color:var(--color-text-secondary);margin-bottom:24px;line-height:1.6;">Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª ÙˆØ³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</div>
                <div style="display:flex;gap:10px;">
                    <button onclick="doClearAll()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:var(--radius-md);cursor:pointer;font-family:var(--font-family);font-size:14px;font-weight:600;">Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                    <button onclick="closeModal('modal-clear')" style="flex:1;padding:12px;background:var(--color-bg-hover);border:1px solid var(--color-border);border-radius:var(--radius-md);cursor:pointer;font-family:var(--font-family);font-size:14px;color:var(--color-text-secondary);">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

<script>
const SAVED_KEY = 'hadith-saved';
const PREFS_KEY = 'hadith-prefs';
const TOTAL_HADITHS = 40;

// â”€â”€ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPrefs() {
    try { return JSON.parse(localStorage.getItem(PREFS_KEY)) || {}; }
    catch { return {}; }
}

function savePrefs(prefs) {
    localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
}

function savePref(key, val) {
    const prefs = getPrefs();
    prefs[key] = val;
    savePrefs(prefs);
}

function getSaved() {
    try { return JSON.parse(localStorage.getItem(SAVED_KEY)) || []; }
    catch { return []; }
}

// â”€â”€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
    const prefs = getPrefs();
    const saved = getSaved();
    const name = prefs.name || 'Ø²Ø§Ø¦Ø±';

    // Header
    document.getElementById('profile-name-text').textContent = name;
    document.getElementById('profile-avatar').textContent = name.charAt(0) || 'Ø£';
    document.getElementById('profile-joined').textContent =
        prefs.joinedAt ? `Ø¹Ø¶Ùˆ Ù…Ù†Ø° ${new Date(prefs.joinedAt).toLocaleDateString('ar-SA', {year:'numeric',month:'long'})}` : 'Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯';

    if (!prefs.joinedAt) { prefs.joinedAt = Date.now(); savePrefs(prefs); }

    // Stats
    document.getElementById('stat-saved').textContent = saved.length;
    document.getElementById('stat-read').textContent = (prefs.readIds || []).length;
    document.getElementById('stat-quiz').textContent = prefs.quizScore || 0;
    document.getElementById('stat-streak').textContent = calcStreak(prefs);

    // Settings inputs
    document.getElementById('name-input').value = name;

    // Render
    renderSaved(saved);
    renderProgress(saved, prefs);
    renderAchievements(saved, prefs);
});

function calcStreak(prefs) {
    const days = prefs.activeDays || [];
    if (!days.length) return 0;
    days.sort((a, b) => b - a);
    let streak = 1;
    for (let i = 1; i < days.length; i++) {
        if (days[i - 1] - days[i] === 1) streak++;
        else break;
    }
    return streak;
}

// â”€â”€ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSaved(saved) {
    const container = document.getElementById('saved-list');
    if (!saved.length) {
        container.innerHTML = `
            <div class="empty-state">
                <span class="material-icons-outlined">bookmark_border</span>
                <p>Ù„Ù… ØªØ­ÙØ¸ Ø£ÙŠ Ø­Ø¯ÙŠØ« Ø¨Ø¹Ø¯</p>
                <a href="/"><span class="material-icons-outlined">explore</span> ØªØµÙØ­ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«</a>
            </div>`;
        return;
    }

    container.innerHTML = saved.map(h => `
        <a href="/hadith/${h.id}" class="saved-card">
            <div class="saved-card-num">${h.id}</div>
            <div class="saved-card-body">
                <div class="saved-card-title">${h.title}</div>
                <div class="saved-card-meta">
                    <span class="material-icons-outlined" style="font-size:13px">person</span>
                    ${h.narrator}
                    <span style="opacity:0.4">â€¢</span>
                    ${new Date(h.savedAt).toLocaleDateString('ar-SA', {month:'short',day:'numeric'})}
                </div>
            </div>
            <button class="unsave-btn" onclick="unsave(event, ${h.id})" title="Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª">
                <span class="material-icons-outlined">bookmark_remove</span>
            </button>
        </a>
    `).join('');
}

function unsave(e, id) {
    e.preventDefault();
    e.stopPropagation();
    let saved = getSaved().filter(h => h.id !== id);
    localStorage.setItem(SAVED_KEY, JSON.stringify(saved));
    document.getElementById('stat-saved').textContent = saved.length;
    renderSaved(saved);
    toastManager.show('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª', 'warning');
}

// â”€â”€ Ø§Ù„ØªÙ‚Ø¯Ù… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProgress(saved, prefs) {
    const readCount = (prefs.readIds || []).length;
    const savedCount = saved.length;
    const quizScore = prefs.quizScore || 0;

    const setBar = (id, pctId, value, max) => {
        const pct = Math.round((value / max) * 100);
        document.getElementById(id).style.width = pct + '%';
        document.getElementById(pctId).textContent = `${value}/${max}`;
    };

    setTimeout(() => {
        setBar('bar-read', 'pct-read', readCount, TOTAL_HADITHS);
        setBar('bar-saved', 'pct-saved', savedCount, TOTAL_HADITHS);
        setBar('bar-quiz', 'pct-quiz', Math.min(quizScore, TOTAL_HADITHS), TOTAL_HADITHS);
    }, 200);
}

// â”€â”€ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ACHIEVEMENTS = [
    { id: 'first_save',   icon: 'ğŸ”–', name: 'Ø£ÙˆÙ„ Ø®Ø·ÙˆØ©',      desc: 'Ø§Ø­ÙØ¸ Ø­Ø¯ÙŠØ«Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹',       check: (s,p) => s.length >= 1 },
    { id: 'five_saved',   icon: 'ğŸ“š', name: 'Ù‚Ø§Ø±Ø¦ Ù†Ø´ÙŠØ·',     desc: 'Ø§Ø­ÙØ¸ 5 Ø£Ø­Ø§Ø¯ÙŠØ«',            check: (s,p) => s.length >= 5 },
    { id: 'all_saved',    icon: 'ğŸ†', name: 'Ø­Ø§ÙØ¸',          desc: 'Ø§Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«',        check: (s,p) => s.length >= 40 },
    { id: 'first_quiz',   icon: 'ğŸ¯', name: 'Ù…ØªØ¹Ù„Ù…',         desc: 'Ø£ÙƒÙ…Ù„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹',      check: (s,p) => (p.quizScore||0) >= 1 },
    { id: 'quiz_perfect', icon: 'â­', name: 'Ù…ØªÙ…ÙŠØ²',         desc: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 10 ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',   check: (s,p) => (p.quizScore||0) >= 10 },
    { id: 'streak_3',     icon: 'ğŸ”¥', name: '3 Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©', desc: 'Ø²Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ 3 Ø£ÙŠØ§Ù…',        check: (s,p) => calcStreak(p) >= 3 },
    { id: 'streak_7',     icon: 'ğŸ’', name: 'Ø£Ø³Ø¨ÙˆØ¹ ÙƒØ§Ù…Ù„',    desc: 'Ø²Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ 7 Ø£ÙŠØ§Ù…',        check: (s,p) => calcStreak(p) >= 7 },
    { id: 'read_10',      icon: 'ğŸ“–', name: 'Ø¹Ø§Ø´Ø±',          desc: 'Ø§Ù‚Ø±Ø£ 10 Ø£Ø­Ø§Ø¯ÙŠØ«',            check: (s,p) => (p.readIds||[]).length >= 10 },
];

function renderAchievements(saved, prefs) {
    const grid = document.getElementById('achievements-grid');
    grid.innerHTML = ACHIEVEMENTS.map(a => {
        const earned = a.check(saved, prefs);
        return `
        <div class="achievement ${earned ? 'earned' : ''}">
            <div class="achievement-icon">${a.icon}</div>
            <div class="achievement-name">${a.name}</div>
            <div class="achievement-desc">${a.desc}</div>
        </div>`;
    }).join('');
}

// â”€â”€ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ§Ø¨Ø§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
    console.log('switchTab called:', name);
    console.log('Button:', btn);
    
    const tabs = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.tab-panel');
    const targetPanel = document.getElementById('panel-' + name);
    
    console.log('Tabs found:', tabs.length);
    console.log('Panels found:', panels.length);
    console.log('Target panel:', targetPanel);
    
    if (!targetPanel) {
        console.error('Panel not found: panel-' + name);
        return;
    }
    
    // Remove active from all tabs and panels
    tabs.forEach(b => b.classList.remove('active'));
    panels.forEach(p => p.classList.remove('active'));
    
    // Add active to clicked tab and corresponding panel
    btn.classList.add('active');
    targetPanel.classList.add('active');
    
    console.log('Tab switched successfully to:', name);
}

// â”€â”€ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveName(val) {
    const prefs = getPrefs();
    prefs.name = val.trim() || 'Ø²Ø§Ø¦Ø±';
    savePrefs(prefs);
    document.getElementById('profile-name-text').textContent = prefs.name;
    document.getElementById('profile-avatar').textContent = prefs.name.charAt(0);
    toastManager.show('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…', 'success');
}

// Toggle notifications
function toggleNotifications(checked) {
    if (checked) {
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    savePref('notifications', true);
                    toastManager.show('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', 'success');
                } else {
                    document.getElementById('notifications-toggle').checked = false;
                    toastManager.show('ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', 'warning');
                }
            });
        } else {
            toastManager.show('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', 'error');
            document.getElementById('notifications-toggle').checked = false;
        }
    } else {
        savePref('notifications', false);
        toastManager.show('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', 'info');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­Ø¯Ù‘Ø«
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage â”€â”€
function collectAllData() {
    const prefs = getPrefs();
    const saved = getSaved();
    const quizResults = (() => { try { return JSON.parse(localStorage.getItem('quiz-results') || '[]'); } catch { return []; } })();
    const quizStats  = (() => { try { return JSON.parse(localStorage.getItem('quizStats') || '{}'); } catch { return {}; } })();
    const theme = localStorage.getItem('hadith-app-theme') || 'light';

    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
    const quizByType = {};
    quizResults.forEach(r => {
        const type = r.type || 'unknown';
        if (!quizByType[type]) quizByType[type] = { count: 0, bestScore: 0, totalScore: 0 };
        quizByType[type].count++;
        quizByType[type].bestScore = Math.max(quizByType[type].bestScore, r.score || 0);
        quizByType[type].totalScore += r.score || 0;
    });

    return {
        version: '2.0',
        app: 'Ù†Ø¨Ø±Ø§Ø³ - Ø§Ù„Ø£Ø±Ø¨Ø¹ÙˆÙ† Ø§Ù„Ù†ÙˆÙˆÙŠØ©',
        exportedAt: new Date().toISOString(),
        exportedAtHuman: new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
        data: {
            saved,
            prefs,
            quizResults,
            quizStats,
            theme,
        },
        summary: {
            savedCount:    saved.length,
            readCount:     (prefs.readIds || []).length,
            quizCount:     quizResults.length,
            bestQuizScore: quizStats.bestScore || 0,
            streak:        calcStreak(prefs),
            quizByType,
        }
    };
}

// â”€â”€ ØªØ­Ø¯ÙŠØ« Ù†Øµ "Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±" ÙÙŠ ØµÙ Ø§Ù„ØªØµØ¯ÙŠØ± â”€â”€
function updateExportSub() {
    const data = collectAllData();
    const s = data.summary;
    document.getElementById('export-sub').textContent =
        `${s.savedCount} Ù…Ø­ÙÙˆØ¸ Â· ${s.readCount} Ù…Ù‚Ø±ÙˆØ¡ Â· ${s.quizCount} Ø§Ø®ØªØ¨Ø§Ø±`;
}

// â”€â”€ Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± Ù…Ø¹ Ù…Ù„Ø®Øµ â”€â”€
function showExportPreview() {
    const data = collectAllData();
    const s = data.summary;

    const typeLabels = {
        narrator: 'Ù…Ù† Ø§Ù„Ø±Ø§ÙˆÙŠØŸ', complete: 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ø¯ÙŠØ«', 'which-hadith': 'Ù…Ù† Ø£ÙŠ Ø­Ø¯ÙŠØ«ØŸ',
        vocabulary: 'Ù…Ø¹Ø§Ù†ÙŠ Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª', benefit: 'ÙÙˆØ§Ø¦Ø¯ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«', topic: 'ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«',
        source: 'Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«', 'narrator-tribe': 'Ù‚Ø¨Ø§Ø¦Ù„ Ø§Ù„Ø±ÙˆØ§Ø©', 'narrator-died': 'ØªØ§Ø±ÙŠØ® ÙˆÙØ§Ø© Ø§Ù„Ø±Ø§ÙˆÙŠ',
        'narrations-count': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª', speed: 'Ø§Ù„Ø³Ø¨Ø§Ù‚ Ø¶Ø¯ Ø§Ù„ÙˆÙ‚Øª', 'random-20': 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„', 'first-10': 'Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰',
    };

    const quizRows = Object.entries(s.quizByType).map(([type, info]) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--color-border);">
            <span style="font-size:12px;color:var(--color-text-secondary);">${typeLabels[type] || type}</span>
            <span style="font-size:12px;font-weight:600;color:var(--color-text-primary);">${info.count} Ø§Ø®ØªØ¨Ø§Ø± Â· Ø£ÙØ¶Ù„: ${info.bestScore}</span>
        </div>`).join('') || '<div style="font-size:12px;color:var(--color-text-secondary);text-align:center;padding:8px 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯</div>';

    document.getElementById('export-summary').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
            ${[
                ['bookmark', 'Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', s.savedCount, '#10b981'],
                ['menu_book', 'Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©', s.readCount, '#6366f1'],
                ['quiz', 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙØ¬Ø±Ø§Ø©', s.quizCount, '#f59e0b'],
                ['local_fire_department', 'Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©', s.streak, '#ef4444'],
            ].map(([icon, label, val, color]) => `
                <div style="background:var(--color-bg-hover);border-radius:10px;padding:12px;text-align:center;">
                    <span class="material-icons-outlined" style="font-size:20px;color:${color};">${icon}</span>
                    <div style="font-size:20px;font-weight:700;color:var(--color-text-primary);margin:4px 0;">${val}</div>
                    <div style="font-size:11px;color:var(--color-text-secondary);">${label}</div>
                </div>`).join('')}
        </div>
        <div style="background:var(--color-bg-hover);border-radius:10px;padding:14px;margin-bottom:4px;">
            <div style="font-size:12px;font-weight:700;color:var(--color-text-primary);margin-bottom:10px;display:flex;align-items:center;gap:6px;">
                <span class="material-icons-outlined" style="font-size:15px;color:var(--color-primary);">analytics</span>
                ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            </div>
            ${quizRows}
        </div>`;

    openModal('modal-export');
}

// â”€â”€ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„ÙØ¹Ù„ÙŠ â”€â”€
let _exportData = null;
function doExport() {
    if (!_exportData) _exportData = collectAllData();
    const blob = new Blob([JSON.stringify(_exportData, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const date = new Date().toISOString().split('T')[0];
    a.download = `Ù†Ø¨Ø±Ø§Ø³-${date}.json`;
    a.click();
    closeModal('modal-export');
    toastManager.show('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    _exportData = null;
}

// â”€â”€ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© â”€â”€
let _importParsed = null;
function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    event.target.value = '';

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const raw = JSON.parse(e.target.result);
            if (!raw || typeof raw !== 'object') throw new Error('ØµÙŠØºØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');

            // Ø¯Ø¹Ù… ÙƒÙ„Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±ÙŠÙ† v1 Ùˆ v2
            const isV2 = raw.version === '2.0' && raw.data;
            const incoming = isV2 ? raw.data : raw;

            _importParsed = {
                saved:       Array.isArray(incoming.saved) ? incoming.saved : [],
                prefs:       (incoming.prefs && typeof incoming.prefs === 'object') ? incoming.prefs : {},
                quizResults: Array.isArray(incoming.quizResults) ? incoming.quizResults : (incoming.quizScores || []),
                quizStats:   (incoming.quizStats && typeof incoming.quizStats === 'object') ? incoming.quizStats : {},
                theme:       incoming.theme || null,
                exportedAt:  raw.exportedAt || raw.exportedAtHuman || null,
                version:     raw.version || '1.0',
            };

            _showImportPreview(_importParsed, raw.summary || null);
            openModal('modal-import');
        } catch(err) {
            console.error(err);
            toastManager.show('âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù…Ù„Ù Ù†Ø¨Ø±Ø§Ø³ ØµØ§Ù„Ø­.', 'error');
        }
    };
    reader.readAsText(file);
}

function _showImportPreview(d, summary) {
    const existing = collectAllData();
    const conflicts = [];

    if (d.saved.length > 0 && existing.data.saved.length > 0) {
        const existingIds = new Set(existing.data.saved.map(h => h.id));
        const overlap = d.saved.filter(h => existingIds.has(h.id)).length;
        if (overlap > 0) conflicts.push(`${overlap} Ø­Ø¯ÙŠØ« Ù…Ø­ÙÙˆØ¸ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„`);
    }
    if (d.quizResults.length > 0 && existing.data.quizResults.length > 0) {
        conflicts.push(`Ù„Ø¯ÙŠÙƒ ${existing.data.quizResults.length} Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø¬Ù‘Ù„`);
    }

    const exportDate = d.exportedAt
        ? new Date(d.exportedAt).toLocaleDateString('ar-SA', { year:'numeric', month:'long', day:'numeric' })
        : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    document.getElementById('import-summary').innerHTML = `
        <div style="background:var(--color-bg-hover);border-radius:10px;padding:14px;margin-bottom:12px;">
            <div style="font-size:11px;color:var(--color-text-secondary);margin-bottom:4px;">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${exportDate} Â· Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${d.version}</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:4px;">
            ${[
                ['bookmark', 'Ù…Ø­ÙÙˆØ¸Ø§Øª', d.saved.length, '#10b981'],
                ['menu_book', 'Ø£ÙŠØ§Ù… Ù†Ø´Ø§Ø·', (d.prefs.activeDays||[]).length, '#6366f1'],
                ['quiz', 'Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª', d.quizResults.length, '#f59e0b'],
                ['emoji_events', 'Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©', d.quizStats.bestScore || 0, '#ef4444'],
            ].map(([icon, label, val, color]) => `
                <div style="background:var(--color-bg-card);border:1px solid var(--color-border);border-radius:10px;padding:10px;text-align:center;">
                    <span class="material-icons-outlined" style="font-size:18px;color:${color};">${icon}</span>
                    <div style="font-size:18px;font-weight:700;color:var(--color-text-primary);margin:3px 0;">${val}</div>
                    <div style="font-size:11px;color:var(--color-text-secondary);">${label}</div>
                </div>`).join('')}
        </div>`;

    const conflictBox = document.getElementById('import-conflict-box');
    if (conflicts.length > 0) {
        conflictBox.style.display = 'block';
        document.getElementById('import-conflict-text').textContent =
            'ØªØ¹Ø§Ø±Ø¶Ø§Øª Ù…Ø­ØªÙ…Ù„Ø©: ' + conflicts.join('ØŒ ') + '. Ø§Ø®ØªØ± "Ø¯Ù…Ø¬" Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø£Ùˆ "Ø§Ø³ØªØ¨Ø¯Ø§Ù„" Ù„ØªØ¬Ø§ÙˆØ² ÙƒÙ„ Ø´ÙŠØ¡.';
    } else {
        conflictBox.style.display = 'none';
    }
}

// â”€â”€ ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ â”€â”€
function doImport(mode) {
    if (!_importParsed) return;
    const d = _importParsed;

    try {
        if (mode === 'merge') {
            // Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª
            const existingSaved = getSaved();
            const existingIds = new Set(existingSaved.map(h => h.id));
            const merged = [...existingSaved, ...d.saved.filter(h => !existingIds.has(h.id))];
            localStorage.setItem(SAVED_KEY, JSON.stringify(merged));

            // Ø¯Ù…Ø¬ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            const existingResults = (() => { try { return JSON.parse(localStorage.getItem('quiz-results') || '[]'); } catch { return []; } })();
            const mergedResults = [...existingResults, ...d.quizResults].slice(-100);
            localStorage.setItem('quiz-results', JSON.stringify(mergedResults));

            // Ø¯Ù…Ø¬ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯)
            const existingPrefs = getPrefs();
            const mergedPrefs = { ...d.prefs, ...existingPrefs };
            // Ø¯Ù…Ø¬ readIds
            const readSet = new Set([...(existingPrefs.readIds || []), ...(d.prefs.readIds || [])]);
            mergedPrefs.readIds = [...readSet];
            // Ø¯Ù…Ø¬ activeDays
            const daysSet = new Set([...(existingPrefs.activeDays || []), ...(d.prefs.activeDays || [])]);
            mergedPrefs.activeDays = [...daysSet];
            localStorage.setItem(PREFS_KEY, JSON.stringify(mergedPrefs));

            // Ø¯Ù…Ø¬ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            const existingStats = (() => { try { return JSON.parse(localStorage.getItem('quizStats') || '{}'); } catch { return {}; } })();
            const mergedStats = {
                completed: (existingStats.completed || 0) + (d.quizStats.completed || 0),
                bestScore: Math.max(existingStats.bestScore || 0, d.quizStats.bestScore || 0),
            };
            localStorage.setItem('quizStats', JSON.stringify(mergedStats));

        } else {
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙ„
            localStorage.setItem(SAVED_KEY, JSON.stringify(d.saved));
            localStorage.setItem(PREFS_KEY, JSON.stringify(d.prefs));
            localStorage.setItem('quiz-results', JSON.stringify(d.quizResults));
            localStorage.setItem('quizStats', JSON.stringify(d.quizStats));
        }

        if (d.theme) {
            localStorage.setItem('hadith-app-theme', d.theme);
        }

        closeModal('modal-import');
        toastManager.show(mode === 'merge' ? 'âœ… ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        setTimeout(() => location.reload(), 1400);
    } catch(err) {
        console.error(err);
        toastManager.show('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'error');
    }
    _importParsed = null;
}

// â”€â”€ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø³Ø­ â”€â”€
function showClearConfirm() {
    openModal('modal-clear');
}

function doClearAll() {
    localStorage.removeItem(SAVED_KEY);
    localStorage.removeItem(PREFS_KEY);
    localStorage.removeItem('quiz-results');
    localStorage.removeItem('quizStats');
    closeModal('modal-clear');
    toastManager.show('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'warning');
    setTimeout(() => location.reload(), 1200);
}

// â”€â”€ Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ â”€â”€
function openModal(id) {
    const m = document.getElementById(id);
    if (m) { m.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
}

function closeModal(id) {
    const m = document.getElementById(id);
    if (m) { m.style.display = 'none'; document.body.style.overflow = ''; }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡
document.addEventListener('click', function(e) {
    ['modal-export','modal-import','modal-clear'].forEach(id => {
        const m = document.getElementById(id);
        if (m && e.target === m) closeModal(id);
    });
});

// ØªØ­Ø¯ÙŠØ« ÙˆØµÙ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(updateExportSub, 100);
});
</script>
{% endblock %}
